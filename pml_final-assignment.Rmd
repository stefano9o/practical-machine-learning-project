---
title: "A machine learnig algorithm for activity recognition"
author: "Stefano Galeano"
date: "28/12/2017"
output:
  pdf_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This work is the final asssignement for the "Practical Machine Learning" course administred by Jhon Hopkins University. The dataset used here is from http://groupware.les.inf.puc-rio.br/har, where the authors proposed a model-based approch for recognizing how well an activity it's performed. In the paper, they compared their work with a machine learning algorithm for mistake detection, demonstrating the advantages in using the model-based approch. In this work, we're going to use the data provided by the authors, in order to create a simple machine learning algorithm for human activity recognition (HAR).

The work is organized as follow: in the first section we're going to retreive the data from the source and extract the interting feature; in the second section, we're going to perform some basic exploratory analysis, and in the last section we'll estimate an out-of-sample accuracy of the ML algorithm, using a fresh and never used dataset.

## Getting and cleaning data

```{r, message=TRUE, warning=TRUE, cache=TRUE}
trainUrl <- 'https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv'
testUrl <- 'https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv'

download.file(url = trainUrl,destfile = 'data/train.csv')
download.file(url = testUrl,destfile = 'data/test.csv')
train <- read.csv('data/train.csv', header = TRUE,
                  stringsAsFactors = FALSE, na.strings = c("NA","#DIV/0!",""))
test <- read.csv('data/test.csv', header = TRUE,
                 stringsAsFactors = FALSE, na.strings = c("NA","#DIV/0!",""))
```

```{r}
library(caret)

rawFeatures <- grep(pattern = "^(accel|gyros|magnet)_.*_(x|y|z)$",x = names(train))
rawFeatures <- c(rawFeatures,grep(pattern = "^(roll|pitch|yaw)_.*",x = names(train)))
rawFeatures <- c(rawFeatures,grep(pattern = "^total_accel.*",x = names(train)))

ds.sel <- train[,rawFeatures]
ds.sel$classe <- as.factor(train$classe)
```

```{r}
rawFeatures <- grep(pattern = "^(accel|gyros|magnet)_.*_(x|y|z)$",x = names(test))
rawFeatures <- c(rawFeatures,grep(pattern = "^(roll|pitch|yaw)_.*",x = names(test)))
rawFeatures <- c(rawFeatures,grep(pattern = "^total_accel.*",x = names(test)))
quiz.sel <- test[,rawFeatures]
```

The data are then splitted in train and test set:

```{r}
inTrain <- createDataPartition(ds.sel$classe,p=.75,list = FALSE)

train.sel <- ds.sel[inTrain,]
test.sel <- ds.sel[-inTrain,]
```

## Exploratory data analysis


```{r}
isFactor <- sapply(train.sel,is.factor)
train.cor <- cor(train.sel[,-which(isFactor)])
highlyCorrelated <- findCorrelation(train.cor, cutoff=0.75, names = TRUE)
train.sel[,highlyCorrelated] <- NULL
```

```{r cache=TRUE}
library(parallel)
library(doParallel)
cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

control <- trainControl(method="cv", number=10,allowParallel = TRUE)
model <- train(classe~., data=train.sel, method="rf", trControl=control)
stopCluster(cluster)
registerDoSEQ()
```

```{r}
importance <- varImp(model, scale=FALSE)
ord <- order(importance$importance,decreasing = TRUE)

plot(importance)
```


```{r}
km <- kmeans(train$raw_timestamp_part_1,centers = 20)

df <- data.frame(time = as.factor(km$cluster), yaw_belt = train$yaw_belt, subject = as.factor(train$user_name))
g <- ggplot(df,mapping = aes(x=time,y=yaw_belt,color=subject))
# g <- g + ylim(0.7, 1)
g <- g + geom_jitter()
g <- g + xlab("time")
g <- g + ylab("yaw belt")
g
```
```{r}
pred <- predict(model,newdata = test.sel)
confMatrix <- confusionMatrix(data = pred,test.sel$classe)
print(confMatrix$overall)
confMatrix$table
```
```{r}
predict(model,newdata = quiz.sel)
```
```
## Conclusion
