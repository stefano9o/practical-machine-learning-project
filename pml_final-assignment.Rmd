---
title: "pml_final-assignment"
author: "Stefano Galeano"
date: "9/14/2017"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# PML - Final assignment

## Introduction

## Exploratory data analysis

```{r, message=TRUE, warning=TRUE, include=FALSE}
trainUrl <- 'https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv'
testUrl <- 'https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv'

download.file(url = trainUrl,destfile = 'data/train.csv')
download.file(url = testUrl,destfile = 'data/test.csv')
train <- read.csv('data/train.csv', header = TRUE, stringsAsFactors = FALSE, na.strings = c("NA","#DIV/0!",""))
test <- read.csv('data/test.csv', header = TRUE, stringsAsFactors = FALSE, na.strings = c("NA","#DIV/0!",""))
```

```{r}
train.sel$classe <- as.factor(train$classe)

rawFeatures <- grep(pattern = "^(accel|gyros|magnet)_.*_(x|y|z)$",x = names(train))
rawFeatures <- c(rawFeatures,grep(pattern = "^(roll|pitch|yaw)_.*",x = names(train)))
rawFeatures <- c(rawFeatures,grep(pattern = "^total_accel.*",x = names(train)))
train.sel <- train[,rawFeatures]
```

```{r}
rawFeatures <- grep(pattern = "^(accel|gyros|magnet)_.*_(x|y|z)$",x = names(test))
rawFeatures <- c(rawFeatures,grep(pattern = "^(roll|pitch|yaw)_.*",x = names(test)))
rawFeatures <- c(rawFeatures,grep(pattern = "^total_accel.*",x = names(test)))
test.sel <- test[,rawFeatures]
```

```{r}
ncol(train.sel)
naFeatureIndexes <- sapply(names(train.sel),function(featureName){
        sum(is.na(train.sel[,featureName]))/nrow(train.sel) > .8
})
length(which(naFeatureIndexes))
train.sel[,naFeatureIndexes] <- NULL
ncol(train.sel)
```
```{r}
library(Hmisc)

sum(is.na(train.sel))
train.sel[,] <- lapply(train.sel[,],impute,median)
sum(is.na(train.sel))
```

```{r}
library(caret)

ntzVars <- nearZeroVar(train.sel)
summary(train.sel[,ntzVars])
train.sel[,ntzVars] <- NULL
```

```{r}
outcomeIndex <- which(names(train.sel) == "classe")
train.cor <- cor(train.sel[,-outcomeIndex])
highlyCorrelated <- findCorrelation(train.cor, cutoff=0.75, names = TRUE)
train.sel[,highlyCorrelated] <- NULL
```

```{r}
control <- trainControl(method="repeatedcv", number=10, repeats=10)
model <- train(classe~., data=train.sel, method="rf", preProcess="scale", trControl=control)
importance <- varImp(model, scale=FALSE)
ord <- order(importance$importance,decreasing = TRUE)

plot(importance)
outcomeIndex <- which(names(train.sel) == "classe")
train.sel2 <- train.sel[,c(outcomeIndex,ord[1:9])]
```

```{r}
library(Boruta)

set.seed(123)
boruta.train <- Boruta(classe~., data = train.sel, doTrace = 2)
print(boruta.train)
str(boruta.train$finalDecision)
train.sel2 <- train.sel[,boruta.train$finalDecision == "Confirmed"]
```

```{r}
# Random Search
metric <- "Accuracy"
control <- trainControl(method="repeatedcv", number=10, repeats=3, search="random")
set.seed(1234)

fit.rf <- train(classe~., data=train.sel2, method="rf", metric=metric, tuneLength=15, trControl=control)
print(fit.rf)
plot(fit.rf)
```
## Conclusion
